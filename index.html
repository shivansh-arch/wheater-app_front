<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Hub - Live & Forecast</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #eef2f7; /* Lighter blue-gray background */
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

  <!-- Main Application Container -->
  <div class="app-container bg-white p-6 sm:p-8 rounded-2xl shadow-xl w-full max-w-lg mx-auto transition-all duration-300 transform scale-100">

    <!-- Header -->
    <h1 class="text-center text-4xl font-extrabold text-blue-600 mb-8 tracking-tight">Weather Hub</h1>

    <!-- Search Form -->
    <form id="weatherForm" class="space-y-6">
      <div class="form-group relative">
        <label for="city" class="block text-gray-700 font-semibold mb-2">City Name (Optional):</label>
        <input type="text" id="city" placeholder="e.g., London, New York"
               class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
      </div>
      <div class="form-group flex items-center justify-between space-x-4">
        <div class="w-1/2">
          <label for="lat" class="block text-gray-700 font-semibold mb-2">Latitude:</label>
          <input type="number" step="any" id="lat" placeholder="e.g., 28.61"
                 class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
        </div>
        <div class="w-1/2">
          <label for="lon" class="block text-gray-700 font-semibold mb-2">Longitude:</label>
          <input type="number" step="any" id="lon" placeholder="e.g., 77.23"
                 class="w-full px-4 py-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200">
        </div>
      </div>
      <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transform transition-all duration-200 ease-in-out hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
        Get Weather & Location
      </button>
      <p class="text-sm text-center text-gray-500 mt-4">You can use either a city name OR latitude and longitude.</p>
    </form>

    <!-- Feedback and Loading/Error Messages -->
    <div id="feedback" class="mt-8 py-4 px-6 rounded-xl text-center text-sm font-medium" style="display:none;"></div>
    
    <!-- Weather Display Section -->
    <div id="weatherDisplay" class="weather-display mt-8 space-y-8" style="display:none;">
      
      <!-- Location Info -->
      <div class="location-info text-center">
          <h2 id="placeName" class="text-3xl font-bold text-gray-800 mb-2"></h2>
          <p id="coordinates" class="text-gray-500 text-sm italic"></p>
      </div>

      <!-- Current Weather Card -->
      <div class="current-weather bg-gray-50 p-6 rounded-2xl shadow-md border border-gray-200">
        <h3 class="text-2xl font-bold text-blue-600 mb-4 border-b pb-2">Current Weather</h3>
        <div id="currentWeatherDetails" class="space-y-4"></div>
      </div>

      <!-- 7-Day Forecast Card -->
      <div class="forecast bg-gray-50 p-6 rounded-2xl shadow-md border border-gray-200">
        <h3 class="text-2xl font-bold text-blue-600 mb-4 border-b pb-2">7-Day Forecast</h3>
        <div id="forecastDetails" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4"></div>
      </div>
    </div>
  </div>

  <script>
    const weatherCodes = {
      0: 'Clear sky', 1: 'Mainly clear', 2: 'Partly cloudy', 3: 'Overcast',
      45: 'Fog', 48: 'Depositing rime fog',
      51: 'Light drizzle', 53: 'Moderate drizzle', 55: 'Dense drizzle',
      56: 'Light freezing drizzle', 57: 'Dense freezing drizzle',
      61: 'Slight rain', 63: 'Moderate rain', 65: 'Heavy rain',
      66: 'Light freezing rain', 67: 'Heavy freezing rain',
      71: 'Slight snow fall', 73: 'Moderate snow fall', 75: 'Heavy snow fall',
      77: 'Snow grains',
      80: 'Slight rain showers', 81: 'Moderate rain showers', 82: 'Violent rain showers',
      85: 'Slight snow showers', 86: 'Heavy snow showers',
      95: 'Thunderstorm', 96: 'Thunderstorm with slight hail', 99: 'Thunderstorm with heavy hail'
    };

    function getWeatherDescription(code) {
      return weatherCodes[code] || 'Condition unavailable';
    }

    document.addEventListener('DOMContentLoaded', function() {
      const weatherForm = document.getElementById('weatherForm');
      const cityInput = document.getElementById('city');
      const latInput = document.getElementById('lat');
      const lonInput = document.getElementById('lon');
      const feedbackDiv = document.getElementById('feedback');
      const weatherDisplayDiv = document.getElementById('weatherDisplay');
      const placeNameDiv = document.getElementById('placeName');
      const coordinatesDiv = document.getElementById('coordinates');
      const currentWeatherDetailsDiv = document.getElementById('currentWeatherDetails');
      const forecastDetailsDiv = document.getElementById('forecastDetails');

      weatherForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        // Determine if searching by city or lat/lon
        const city = cityInput.value.trim();
        const lat = latInput.value.trim();
        const lon = lonInput.value.trim();

        if (!city && (!lat || !lon)) {
            feedbackDiv.style.display = 'block';
            feedbackDiv.className = 'bg-red-200 text-red-700 font-medium px-4 py-3 rounded-xl shadow-md';
            feedbackDiv.textContent = 'Please enter a city name or latitude and longitude.';
            weatherDisplayDiv.style.display = 'none';
            return;
        }

        feedbackDiv.style.display = 'block';
        feedbackDiv.className = 'bg-blue-200 text-blue-700 font-medium px-4 py-3 rounded-xl shadow-md';
        feedbackDiv.textContent = 'Fetching weather and location data...';
        weatherDisplayDiv.style.display = 'none';

        let apiUrl;
        if (city) {
            apiUrl = `/weather?city=${encodeURIComponent(city)}`;
        } else {
            apiUrl = `/weather?lat=${lat}&lon=${lon}`;
        }

        try {
          const res = await fetch(apiUrl);
          const data = await res.json();

          if (!res.ok) {
            throw new Error(data.error || `HTTP error! Status: ${res.status}`);
          }

          feedbackDiv.style.display = 'none';
          weatherDisplayDiv.style.display = 'block';

          // Display Place Name
          placeNameDiv.textContent = (data.location && data.location.name) ? data.location.name : 'Location data unavailable';
          coordinatesDiv.textContent = `Lat: ${data.location.latitude.toFixed(4)}, Lon: ${data.location.longitude.toFixed(4)}`;

          // Display Current Weather
          const current = data.currentWeather;
          const currentUnits = data.currentWeatherUnits;
          if (current && currentUnits) {
            currentWeatherDetailsDiv.innerHTML = `
              <div class="flex justify-between items-center py-2 border-b border-gray-200">
                <span class="text-gray-600 font-medium">Temperature:</span>
                <span class="text-gray-800 font-bold">${current.temperature_2m ?? 'N/A'}${currentUnits.temperature_2m ?? ''}</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-gray-200">
                <span class="text-gray-600 font-medium">Feels Like:</span>
                <span class="text-gray-800 font-bold">${current.apparent_temperature ?? 'N/A'}${currentUnits.apparent_temperature ?? ''}</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-gray-200">
                <span class="text-gray-600 font-medium">Humidity:</span>
                <span class="text-gray-800 font-bold">${current.relative_humidity_2m ?? 'N/A'}${currentUnits.relative_humidity_2m ?? ''}</span>
              </div>
              <div class="flex justify-between items-center py-2 border-b border-gray-200">
                <span class="text-gray-600 font-medium">Wind Speed:</span>
                <span class="text-gray-800 font-bold">${current.wind_speed_10m ?? 'N/A'}${currentUnits.wind_speed_10m ?? ''}</span>
              </div>
              <div class="flex justify-between items-center py-2">
                <span class="text-gray-600 font-medium">Condition:</span>
                <span class="text-gray-800 font-bold">${getWeatherDescription(current.weather_code)}</span>
              </div>
            `;
          } else {
            currentWeatherDetailsDiv.innerHTML = '<p class="text-center text-gray-500">Current weather data not available.</p>';
          }
          
          // Display 7-Day Forecast
          const daily = data.dailyForecast;
          const dailyUnits = data.dailyForecastUnits;
          forecastDetailsDiv.innerHTML = ''; 

          if (daily && daily.time && daily.time.length > 0) {
            for (let i = 0; i < daily.time.length; i++) { 
              const dayDiv = document.createElement('div');
              dayDiv.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-200';
              dayDiv.innerHTML = `
                <p class="text-lg font-bold text-blue-600 mb-2">${new Date(daily.time[i]).toLocaleDateString('en-US', { weekday: 'long' })}</p>
                <p class="text-sm text-gray-500 mb-2">${new Date(daily.time[i]).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                <div class="space-y-1 text-sm">
                    <p><span class="text-gray-600">Max Temp:</span> <span class="font-bold">${daily.temperature_2m_max[i] ?? 'N/A'}${dailyUnits?.temperature_2m_max ?? '°C'}</span></p>
                    <p><span class="text-gray-600">Min Temp:</span> <span class="font-bold">${daily.temperature_2m_min[i] ?? 'N/A'}${dailyUnits?.temperature_2m_min ?? '°C'}</span></p>
                    <p><span class="text-gray-600">Condition:</span> <span class="font-bold">${getWeatherDescription(daily.weather_code[i])}</span></p>
                    ${daily.sunrise && daily.sunrise[i] ? `<p class="text-xs text-gray-500"><span class="font-medium">Sunrise:</span> ${new Date(daily.sunrise[i]).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</p>` : ''}
                    ${daily.sunset && daily.sunset[i] ? `<p class="text-xs text-gray-500"><span class="font-medium">Sunset:</span> ${new Date(daily.sunset[i]).toLocaleTimeString('en-US', {hour: '2-digit', minute:'2-digit'})}</p>` : ''}
                </div>
              `;
              forecastDetailsDiv.appendChild(dayDiv);
            }
          } else {
            forecastDetailsDiv.innerHTML = '<p class="text-center text-gray-500">Forecast data not available.</p>';
          }

        } catch (err) {
          console.error('Frontend Error:', err);
          feedbackDiv.className = 'bg-red-200 text-red-700 font-medium px-4 py-3 rounded-xl shadow-md';
          feedbackDiv.textContent = `Error: ${err.message}. Please check your input or try again later.`;
          weatherDisplayDiv.style.display = 'none';
        }
      });
    });
  </script>
</body>
</html>
